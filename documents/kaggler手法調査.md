# Kaggler手法研究


##  Kaggler
Nazim Cherpanov  
https://www.kaggle.com/nazimcherpanov


## 関連サイト
- https://www.kaggle.com/code/nazimcherpanov/0-96298-loan-approval-prediction#8.-Final-Model-Training

##  予測精度
.96298

##  モデル
- LightGBM
- XGBoost

##  処理の流れ
- トレーニングデータとテストデータ、オリジナルデータを読み込む
- トレーニングデータとオリジナルデータを合体させる（91226 rows × 12 columns）
- ターゲットの値になにがあり、割合を表示
- nullチェック
- データ型チェック
- objectをラベルエンコーディングする
- 欠損値補完する（平均値）
- 年齢に対しヒストグラムにプロット
- person_home_ownershipをグラフで可視化してターゲットの割合を可視化
- 箱ひげ図でグラフプロット　


Data Preprocessing & Cleaning（データの前処理とクリーニング）  
■DataCleanerクラスを定義　
 - fit_label_encoders：objectクラスでラベルエンコーディングするカラムを選択する処理
 - transform_labels：fit_label_encodersで選択したカラムを実際にエンコーディングする処理
 - impute_numeric：float, intクラスの欠損値補完　K近傍法で行っている


- DataCleanerクラスを利用したデータクリーニング開始
- トレーニングデータはfit_label_encoders処理をする
- トレーニングデータ＆テストデータをラベルエンコーディングする
- ラベルエンコーディング後、両データを欠損値補完する（impute_numeric）
- 箱ひげ図による外れ値を除去


特徴量の作成（特徴量エンジニアリング）  
■比率　
 - income_to_age：収入/年齢　person_income/person_age【相関係数： 0.1】
 - rate_to_loan：ローン利率/ローン金額　←　借入の条件やリスクを間接的に反映（重要らしい）　loan_int_rate/loan_amnt【相関係数：0.11】
 - loan_to_employment：ローン金額/勤続年数　loan_amnt/person_emp_length【相関係数：0.1】
 - rate_to_credit_history： ローン利率/信用履歴の期間　loan_int_rate/cb_person_cred_hist_length【相関係数：0.0】
 - age_to_credit_history：年齢/信用履歴の期間　person_age/cb_person_cred_hist_length【相関係数： 0.87】　←　相関がめちゃ高い(箱ひげ図も形が似ている)
 - income_to_loan：収入/ローン金額　person_income/loan_amnt【相関係数： 0.3】
 - loan_to_income：ローン金額/年収　loan_amnt/person_income【相関係数： 0.3】
 - rate_to_age：ローン利率/年齢　loan_int_rate/person_age【相関係数：0.0】
 - 

■非線形変換
 - age_squared：person_age　2乗
 - log_income：person_income　対数
 - age_cubed：person_age　3乗
 - log_loan_amnt：loan_amnt　対数
 - 
 - 

■積
- 
- 
- 
- 

■三角関数
- age_sin：年齢を周期表現している　100で割ると値が-1~1までに収まる
- age_cos：上記のcos版
- 
- 

■その他
●グループ化
- rate_to_grade：ローンの各グレード（A～G）の内でローン利率の平均（各グレードをgroupy）
- normalized_loan_amount：ローンを必要とする理由内でローン金額のZスコア（理由をgroupy）

●high and low
- high_loan_to_income：元カラム「loan_percent_income」が0.5以上　← 0 or 1の値をとる
- is_new_credit_user：信用履歴の期間が1年以内　← 0 or 1の値をとる
- high_interest_rate：ローン利率のうち平均値以上の値　← 0 or 1の値をとる

●その他条件分岐
- intent_home_match：ローンを必要とする理由が「HOMEIMPROVEMENT（改築）」且つ持ち家　← 0 or 1の値をとる
- creditworthiness_score：信用スコアをあわらし「 所得/ローン金額×金利×信用履歴」
- high_risk_flag：ローン収入の割合が0.4以上且つ、ローン率が平均より高い且つ、ローン返済失敗あり　← 0 or 1の値をとる
- stability_score：勤続年数×年収/ローン金額×信用履歴の期間

●分位数
- income_home_mismatch：person_incomeで分位数0.8以上且つ賃貸　← 0 or 1の値をとる
- high_loan_amount：ローン金額で分位数0.75以上　← 0 or 1の値をとる
- age_income_mismatch：30歳未満且つ年収が分位数0.9以上　← 0 or 1の値をとる
- 
- 
- 
- 
- 
- 
##  ポイント
- target = 'loan_status'　ターゲットカラムを変数に格納している（good）
- ワンホットで相関がみられない場合、ラベルエンコーディングで相関も見てみる
- ターゲットと比較して相関は低かったが、異なる特徴量同士で相関が高い場合新たな新たな特徴量として生成してもよい
- 特徴量エンジニアリングで、新たな特徴量を生成するため「比率」「非線形変換」・・・・等あり
- 
- 

##  特徴量エンジニアリング
■比率
- 相関係数が近い者同士で組み合わせる
- 箱ひげ図で似たような形の者同士で組み合わせる
- 経験則で組み合わせる（業界の常識）
- 分子と分母を入れ替えて2つの特徴量を作ることは基本的に意味はない
- 入れ替えても解釈的に意味をなせば、やる価値はあり（迷ったらやるのも手か？）
- 
- 
- 
- 
■非線形変換（対数、平方根、2乗など）
- 見分け方：散布図や残差プロットなどで可視化　
- 見分け方：特徴量（X軸）とターゲット（Y軸）の散布図（ペアプロット）を描く
- 見分け方：カイ二乗検定 ←カテゴリカルデータ（object型のデータで今回でいうperson_home_ownershipを指す）
- 全体の単位のオーダーを合わせるという意味でも利用する　大きい値はLOG、小さい値はべき乗
- 
- 
- 
- 

##  ROC曲線
- モデルの精度を確認するための手法としてROC曲線を利用
- 縦軸：TPR、横軸：FPRとおく
- TPR：予測が正しいと判断＆実際に正しい（TP）/実際に正しい数
- FPR：予測が正しいと判断＆実際は間違え（FP）/実際に間違っている数
- AUC（Area Under the Curve）ROC曲線内の面積（1日回ほど正確）
- AUC値（0.6〜0.7）: 要改善
- AUC値（0.8〜0.9）: 非常に良いモデル。信頼性が高い。　
- AUC値（0.9〜0.1）: 優れたモデル ←オーバーフィッティングの可能性もあり

##  モデル：XGBoost
- XGBClassifierの引数に値を入れていく
- eval_metric：テストデータの評価指標を指定　logloss=負の対数尤度　mse=二乗平均平方誤差  
  loglossの場合、2値分類問題や確率に基づく予測を評価する際に使用される
- tree_method：使用するツリーメソッド　	auto/exact/approx/hist/gpu_hist  
  GPU使ってなっかたら「gpu_hist」はやめたほうがよい
- 
- 
- 
- 
- 
- 
- 
- 
- 
- 
- 
- 


##  課題
- オリジナルデータの実態が分からん
- target = 'loan_status'　ターゲットカラムを変数に格納している
- 
- 
- 
- 
- 


チャットGPTの回答
このコードは、特徴量エンジニアリングを行うための関数 create_features を定義しています。
train と test の両方のデータフレームに対して新しい特徴量を作成しています。以下は、このコードが具体的に何をしているかを説明します。

目的
元のデータセットから新しい情報を引き出す派生特徴量を作成し、モデルの精度向上を図る。
主な処理内容
比率の計算

特徴量間の関係性を示すため、比率を新しい特徴量として追加しています。
income_to_age: 所得と年齢の比率。
loan_to_income: ローン金額と所得の比率。
rate_to_loan: 利率とローン金額の比率。
loan_to_employment: ローン金額と勤務年数の比率。
rate_to_credit_history: 利率と信用履歴長の比率。
非線形変換

特定の特徴量を非線形変換することで、関係性をモデルにより効果的に学習させる。
age_squared: 年齢の2乗。
age_cubed: 年齢の3乗。
log_income: 所得の対数。
log_loan_amnt: ローン金額の対数。
相互作用項

2つの特徴量を掛け合わせ、新しい特徴量を生成。
age_credit_history_interaction: 年齢と信用履歴の積。
age_interest_interaction: 年齢と金利の積。
条件に基づくフラグの生成

特定の条件を満たすかどうかを表す二値の特徴量。
high_loan_to_income: ローンの所得比率が高い場合（50%以上）。
is_new_credit_user: 信用履歴が短い場合（2年未満）。
income_home_mismatch: 所得が高いのに「借家」の場合。
high_loan_amount: ローン金額が第3四分位数より高い場合。
high_risk_flag: 複数の条件を組み合わせたリスクフラグ。
グループごとの統計量

グループ（例: loan_grade, loan_intent）ごとの平均や標準偏差を計算し、正規化した値を作成。
rate_to_grade: 各ローングレードにおける平均金利。
normalized_loan_amount: 各ローン目的内で正規化したローン金額。
周期性の導入

特定の特徴量を周期性を持つ関数で変換。
age_sin: 年齢をサイン関数で変換。
age_cos: 年齢をコサイン関数で変換。
スコアの計算

複数の特徴量を組み合わせたスコアを導入。
stability_score: 勤務年数、所得、ローン金額、信用履歴長から計算した安定性スコア。
creditworthiness_score: 所得、ローン金額、金利、信用履歴を用いた信用スコア。
実行結果
train と test の両方のデータフレームに対し、さまざまな新しい特徴量が追加されます。
考察
メリット:

特徴量の多様性が増すため、モデルがデータ内の複雑なパターンを学習できる。
特に非線形変換や相互作用項は、単純な特徴量では捉えきれない情報をモデルに提供。
注意点:

特徴量が増えると計算量が増加し、モデルの過学習リスクも高まる。
各特徴量の重要性を適宜評価し、不要なものは削除する必要がある。
このコードは、主にローンや信用スコアに関連するデータセットで、モデルの性能向上を目的とした特徴量エンジニアリングを実施する例と言えます。






あなた:
まず比率の計算についてですが、この5つの特徴量「income_to_age」　　「loan_to_income」　　「rate_to_loan」　　「loan_to_employment」　　「rate_to_credit_history」はどうやって決めますか？経験則ですか？
ChatGPT:
ChatGPT
比率の計算に使う特徴量を選ぶ方法には、経験則だけでなく、データの分析やドメイン知識に基づくアプローチがあります。以下に、それぞれの特徴量の決定方法や理由を解説します。

1. 経験則とドメイン知識
比率を計算する特徴量は、対象となる課題（ここではローン審査や信用評価）や業界の一般的な知識に基づいて決定される場合が多いです。
例えば：
「income_to_age」: 所得と年齢の比率は、収入の多寡と生活ステージを関連付ける特徴量で、若い年齢で高収入なら特異点となり得る。
「loan_to_income」: ローン額が収入に対してどれだけ負担になるかは、信用審査やリスク評価で頻繁に利用される指標。
「rate_to_loan」: 金利とローン額の比率は、借入の条件やリスクを間接的に反映するため、重要な指標とされる。
「loan_to_employment」: 勤務年数とローン額の関係から、雇用の安定性に対する借入額の適正性を評価。
「rate_to_credit_history」: 信用履歴の長さと金利の比率は、長期的な信用リスクを示す可能性がある。
2. データ分析に基づくアプローチ
データの可視化:
データを散布図やヒストグラムで可視化し、各特徴量同士の関係性を確認。
例えば、収入と年齢の散布図で明確な傾向があれば比率を作る。
相関分析:
特徴量間の相関を計算し、相関が高いもの同士を組み合わせることで新たな情報を引き出せる。
仮説検証:
特定の比率がターゲット変数（たとえばローン審査結果や信用スコア）に対して意味があるか、仮説を立てて確認。
比率を作成した後、特徴量重要度の計算やモデルの精度を比較して有効性を評価。
3. 比率計算が特に有効な場合
異なるスケールのデータ:
所得（大きな数値）とローン金額（小さな数値）が混在する場合、比率によりスケールの違いを統一。
特定の傾向を強調したい場合:
たとえば、借入額が高いが収入も高い場合、それを正確に反映する指標が必要。
直接の意味を持つ比率:
「収入に対するローン負担率」など、ドメインで直接意味を持つ比率。
4. モデルの性能を基準に選定
一度特徴量を作成し、モデルに学習させて重要度を評価。
比率が有効でない場合、削除して他の特徴量を試す（たとえば、非線形変換や別の相互作用項の生成）。
具体例:
SHAPやPermutation Importanceで作成した比率の有効性を確認する。
まとめ
比率を選ぶ際には、ドメイン知識（対象分野の経験）とデータ分析の両方が鍵となります。
比率が有効かどうかは、仮説検証を通じて確認することが重要。
最終的には、モデルの性能や解釈性に基づいて選定・調整します。
一言で言うなら、ドメイン知識で方向性を決め、データ分析と仮説検証で有効性を確かめるプロセスが標準的です。